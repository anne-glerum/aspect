# This model has a box geometry where simple shear is induced by constant velocity
# along the bottom and top boundaries. Diffusion dislocation creep laws are used, 
# and the viscosity is
# calculated at the first time step for a constant temperature of 1600 K.
# Since the strain rate is fixed, and diffusion viscosity is also fixed at 1e21Pas
# it is possible to compute the corresponding dislocation and effective viscosity and
# check the model for correctness. However there are several pitfalls:
# - The strain-rate visualization plugins computes a different norm for the strain
#   rate than what is used in the material model. The internal strain rate was determined
#   to be 6.33775e-14, of which the dislocation strain rate makes up
#   6.2839e-14.
#
#   Analytically (python script) computed dislocation viscosity: 8.56993808508e+18
#   Numerically (ASPECT) computed dislocation viscosity: 8.56994e+18
#
# The analytic viscosity was computed using the following python program:
#
# import numpy as np
# dislocation_activation_energy = 5.3e5
# dislocation_activation_volume = 1.4e-5
# dislocation_creep_prefactor = 1.1e-16
# adiabatic_pressure = 0.0

# dislocation_creep_exponent = 3.5
# gas_constant = 8.3144621
# temperature = 1600.0
# second_strain_rate_invariant = 6.2839e-14
#
# energy_term = np.exp((dislocation_activation_energy + dislocation_activation_volume * adiabatic_pressure) / (dislocation_creep_exponent * gas_constant * temperature))
#
# strain_rate_dependence = (1.0 - dislocation_creep_exponent) / dislocation_creep_exponent;
#
# dislocation_viscosity = dislocation_creep_prefactor**(-1.0/dislocation_creep_exponent) * second_strain_rate_invariant**strain_rate_dependence * energy_term
#
# print (dislocation_viscosity)
#
# Note that the strain rate output by aspect is the *norm*, but the model itself uses
# the square root of the second invariant. For reference, edot_norm = sqrt(2*edot_ii).
# The depth average output contains viscosity output, and so provides the required test.


set Dimension = 2
set Adiabatic surface temperature = 1600
set Nonlinear solver scheme = single Advection, iterated Stokes

subsection Geometry model
  set Model name = box

  subsection Box
    set X periodic  = true 
    set X extent    = 500e3
    set Y extent    = 500e3
  end
end

# The parameters below this comment were created by the update script
# as replacement for the old 'Model settings' subsection. They can be
# safely merged with any existing subsections with the same name.

subsection Boundary temperature model
  set Fixed temperature boundary indicators   = bottom, top
end

subsection Boundary velocity model
  set Prescribed velocity boundary indicators = bottom:function, top:function
end

subsection Boundary velocity model
  subsection Function
    set Variable names = x,y
    set Function expression = if(y<250e3,1,-1); 0
  end
end


subsection Initial temperature model
  set Model name = function

  subsection Function
    set Function expression = 1600
  end
end

subsection Material model
  set Model name = plume

  subsection Plume model
    set Radial viscosity file name = test-steinberger-compressible/test-radial-visc.txt
    set Use lateral average temperature for viscosity = false
    set Maximum lateral viscosity variation = 1e8
    set Minimum viscosity = 1e1
    set Maximum viscosity = 1e28
    set Reference viscosity = 1e22

    set Use composite rheology = true
    set Dislocation creep prefactor = 1.1e-16
    set Dislocation creep exponent = 3.5
    set Dislocation activation energy = 5.3e5
    set Dislocation activation volume = 1.4e-5
  end
end

subsection Boundary temperature model
  set List of model names = initial temperature
end


subsection Gravity model
  set Model name = vertical

  subsection Vertical
    set Magnitude = 0
  end
end

subsection Mesh refinement
  set Initial global refinement                 = 5
  set Initial adaptive refinement               = 0
end

subsection Termination criteria
  set Termination criteria = end step
  set End step = 0
end

subsection Postprocess
  set List of postprocessors = velocity statistics, basic statistics, temperature statistics, depth average, visualization

  subsection Visualization
    set List of output variables = material properties, strain rate
  end
end
